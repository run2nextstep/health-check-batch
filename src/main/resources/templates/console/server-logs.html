<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{console/layout :: layout(~{::content}, ~{::scripts}, 'Server Logs - ' + ${server.name})}">
<head>
  <title>Server Logs</title>
</head>
<body>
<div th:fragment="content">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/console/">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="/console/servers">Servers</a></li>
      <li class="breadcrumb-item active" th:text="${server.name}">Server Logs</li>
    </ol>
  </nav>

  <!-- Server Info Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-server"></i> <span th:text="${server.name}">Server Name</span>
            <span th:if="${server.enabled}" class="badge bg-success ms-2">Active</span>
            <span th:unless="${server.enabled}" class="badge bg-secondary ms-2">Disabled</span>
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-sm table-borderless">
                <tr>
                  <td><strong>URL:</strong></td>
                  <td><code th:text="${server.url}">-</code></td>
                </tr>
                <tr>
                  <td><strong>Method:</strong></td>
                  <td>
                    <span class="badge bg-secondary" th:text="${server.method}">-</span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Timeout:</strong></td>
                  <td th:text="${server.timeout} + 'ms'">-</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <table class="table table-sm table-borderless">
                <tr>
                  <td><strong>Environment:</strong></td>
                  <td>
                    <span class="badge bg-info" th:text="${server.environment}">-</span>
                  </td>
                </tr>
                <tr>
                  <td><strong>Created:</strong></td>
                  <td th:text="${#temporals.format(server.createdAt, 'yyyy-MM-dd HH:mm')}">-</td>
                </tr>
                <tr>
                  <td><strong>Description:</strong></td>
                  <td th:text="${server.description ?: 'No description'}">-</td>
                </tr>
              </table>
            </div>
          </div>
          <div class="mt-2">
            <a th:href="@{'/console/servers/' + ${server.id} + '/edit'}" class="btn btn-primary btn-sm">
              <i class="fas fa-edit"></i> Edit Server
            </a>
            <button class="btn btn-info btn-sm ms-2" onclick="testServerConnection()">
              <i class="fas fa-play"></i> Test Connection
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logs Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-success" th:text="${#lists.size(logsPage.content.?[success])}">0</h5>
          <p class="card-text">Successful (This Page)</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-danger" th:text="${#lists.size(logsPage.content.?[!success])}">0</h5>
          <p class="card-text">Failed (This Page)</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-info"
              th:with="avgTime=${#aggregates.avg(logsPage.content.![elapsedTimeMs])}"
              th:text="${avgTime != null ? #numbers.formatDecimal(avgTime, 0, 0) + 'ms' : 'N/A'}">0ms</h5>
          <p class="card-text">Avg Response Time</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h5 class="card-title text-warning" th:text="${logsPage.totalElements}">0</h5>
          <p class="card-text">Total Logs</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Execution Logs -->
  <div class="card shadow">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">
        Execution Logs for <span th:text="${server.name}">Server</span>
        <span th:if="${logsPage.totalElements > 0}" class="badge bg-info"
              th:text="${logsPage.totalElements}">0</span>
      </h6>
      <div>
        <button class="btn btn-sm btn-outline-info" onclick="location.reload()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>
    <div class="card-body">
      <div th:if="${logsPage.totalElements == 0}" class="text-center text-muted py-4">
        <i class="fas fa-list-alt fa-3x mb-3"></i>
        <h5>No logs found</h5>
        <p>No execution logs found for this server yet.</p>
        <button class="btn btn-primary" onclick="testServerConnection()">
          <i class="fas fa-play"></i> Run Health Check
        </button>
      </div>

      <div th:unless="${logsPage.totalElements == 0}" class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
          <tr>
            <th>Execution Time</th>
            <th>Status</th>
            <th>Response Time</th>
            <th>Status Code</th>
            <th>Batch ID</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <tr th:each="log : ${logsPage.content}"
              th:class="${log.success ? 'log-success' : 'log-failure'}">
            <td th:text="${#temporals.format(log.executionTime, 'MM-dd HH:mm:ss')}"></td>
            <td>
                                    <span th:if="${log.success}" class="badge bg-success">
                                        <i class="fas fa-check"></i> Success
                                    </span>
              <span th:unless="${log.success}" class="badge bg-danger">
                                        <i class="fas fa-times"></i> Failed
                                    </span>
              <div th:if="${!log.success and log.errorMessage != null}" class="mt-1">
                <small class="text-danger text-truncate d-block" style="max-width: 200px;"
                       th:text="${log.errorMessage}"></small>
              </div>
            </td>
            <td>
                                    <span th:class="${log.elapsedTimeMs < 1000 ? 'response-time-good' :
                                                    (log.elapsedTimeMs < 5000 ? 'response-time-slow' : 'response-time-bad')}"
                                          th:text="${log.elapsedTimeMs} + 'ms'"></span>
            </td>
            <td>
                                    <span th:if="${log.statusCode != null and log.statusCode > 0}"
                                          class="badge"
                                          th:classappend="${log.statusCode >= 200 and log.statusCode < 300 ? 'bg-success' :
                                                         (log.statusCode >= 400 ? 'bg-danger' : 'bg-warning')}"
                                          th:text="${log.statusCode}"></span>
              <span th:unless="${log.statusCode != null and log.statusCode > 0}"
                    class="badge bg-secondary">N/A</span>
            </td>
            <td>
              <small class="text-muted font-monospace" th:text="${log.batchExecutionId}"></small>
            </td>
            <td>
              <a th:href="@{'/console/logs/' + ${log.id}}"
                 class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="View Details">
                <i class="fas fa-eye"></i>
              </a>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div th:if="${logsPage.totalPages > 1}" class="d-flex justify-content-between align-items-center mt-3">
        <div>
          Showing <span th:text="${logsPage.size * logsPage.number + 1}">1</span> to
          <span th:text="${logsPage.size * logsPage.number + logsPage.numberOfElements}">20</span> of
          <span th:text="${logsPage.totalElements}">100</span> entries
        </div>

        <nav aria-label="Server logs pagination">
          <ul class="pagination mb-0">
            <li class="page-item" th:classappend="${logsPage.first} ? 'disabled'">
              <a class="page-link"
                 th:href="@{'/console/servers/' + ${server.id} + '/logs'(page=${logsPage.number - 1})}">
                Previous
              </a>
            </li>

            <li th:each="pageNum : ${#numbers.sequence(0, logsPage.totalPages - 1)}"
                th:if="${pageNum >= logsPage.number - 2 and pageNum <= logsPage.number + 2}"
                class="page-item"
                th:classappend="${pageNum == logsPage.number} ? 'active'">
              <a class="page-link"
                 th:href="@{'/console/servers/' + ${server.id} + '/logs'(page=${pageNum})}"
                 th:text="${pageNum + 1}">1</a>
            </li>

            <li class="page-item" th:classappend="${logsPage.last} ? 'disabled'">
              <a class="page-link"
                 th:href="@{'/console/servers/' + ${server.id} + '/logs'(page=${logsPage.number + 1})}">
                Next
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<div th:fragment="scripts">
  <script>
    function testServerConnection() {
      if (confirm('This will trigger a health check for all active servers. Continue?')) {
        $.post('/api/batch/trigger')
          .done(function(data) {
            alert('Health check triggered successfully! Refresh the page in a moment to see new logs.');
            setTimeout(function() { location.reload(); }, 3000);
          })
          .fail(function() {
            alert('Failed to trigger health check. Please try again.');
          });
      }
    }

    // Initialize tooltips
    $(document).ready(function() {
      $('[data-bs-toggle="tooltip"]').tooltip();
    });

    // Auto-refresh every 60 seconds if on first page
    $(document).ready(function() {
      const urlParams = new URLSearchParams(window.location.search);
      const page = urlParams.get('page') || '0';

      if (page === '0') {
        setTimeout(function() {
          startAutoRefresh(60000);
        }, 5000);
      }
    });
  </script>
</div>
</body>
</html>