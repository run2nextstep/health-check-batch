<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{console/layout :: layout(~{::content}, ~{::scripts}, ${server.id != null ? 'Edit Server' : 'Add New Server'})}">
<head>
  <title>Server Form</title>
</head>
<body>
<div th:fragment="content">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/console/">Dashboard</a></li>
      <li class="breadcrumb-item"><a href="/console/servers">Servers</a></li>
      <li class="breadcrumb-item active" th:text="${server.id != null ? 'Edit Server' : 'Add New Server'}">Server Form</li>
    </ol>
  </nav>

  <!-- Server Form -->
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-server"></i>
            <span th:text="${server.id != null ? 'Edit Server: ' + server.name : 'Add New Server'}">Server Form</span>
          </h6>
        </div>
        <div class="card-body">
          <form th:action="${server.id != null ? '/console/servers/' + server.id + '/update' : '/console/servers'}"
                method="post" th:object="${server}">

            <!-- Basic Information -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="name" class="form-label">Server Name *</label>
                  <input type="text" class="form-control" id="name" th:field="*{name}"
                         placeholder="Enter server name" required>
                  <div class="form-text">A descriptive name for this server</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="environment" class="form-label">Environment</label>
                  <select class="form-control" id="environment" th:field="*{environment}">
                    <option value="dev">Development</option>
                    <option value="test">Test</option>
                    <option value="prod">Production</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- URL and Method -->
            <div class="row">
              <div class="col-md-8">
                <div class="mb-3">
                  <label for="url" class="form-label">URL *</label>
                  <input type="url" class="form-control" id="url" th:field="*{url}"
                         placeholder="https://example.com/api/health" required>
                  <div class="form-text">The full URL to check (including http/https)</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="method" class="form-label">HTTP Method</label>
                  <select class="form-control" id="method" th:field="*{method}" onchange="toggleRequestBody()">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="HEAD">HEAD</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Timeout and Status -->
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="timeout" class="form-label">Timeout (milliseconds)</label>
                  <input type="number" class="form-control" id="timeout" th:field="*{timeout}"
                         min="1000" max="60000" step="1000" value="5000">
                  <div class="form-text">Request timeout in milliseconds (1000-60000)</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Status</label>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enabled" th:field="*{enabled}">
                    <label class="form-check-label" for="enabled">
                      Enable this server for health checks
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Request Body (for POST/PUT) -->
            <div class="mb-3" id="requestBodySection" style="display: none;">
              <label for="requestBody" class="form-label">Request Body (JSON)</label>
              <textarea class="form-control" id="requestBody" th:field="*{requestBody}"
                        rows="4" placeholder='{"key": "value"}'></textarea>
              <div class="form-text">JSON body to send with POST/PUT requests (leave empty for no body)</div>
            </div>

            <!-- Description -->
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" th:field="*{description}"
                        rows="2" placeholder="Optional description of this server"></textarea>
            </div>

            <!-- Form Actions -->
            <div class="d-flex justify-content-between">
              <div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  <span th:text="${server.id != null ? 'Update Server' : 'Create Server'}">Save</span>
                </button>
                <a href="/console/servers" class="btn btn-secondary ms-2">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
              <div th:if="${server.id != null}">
                <a th:href="@{'/console/servers/' + ${server.id} + '/logs'}" class="btn btn-info">
                  <i class="fas fa-list"></i> View Logs
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Connection Card -->
  <div class="row justify-content-center mt-4" th:if="${server.id != null}">
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-info">
            <i class="fas fa-flask"></i> Test Connection
          </h6>
        </div>
        <div class="card-body">
          <p class="text-muted">Test the connection to this server to verify it's working correctly.</p>
          <button type="button" class="btn btn-info" onclick="testConnection()">
            <i class="fas fa-play"></i> Test Connection
          </button>
          <div id="testResult" class="mt-3" style="display: none;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:fragment="scripts">
  <script>
    // Toggle request body section based on method
    function toggleRequestBody() {
      const method = document.getElementById('method').value;
      const section = document.getElementById('requestBodySection');

      if (method === 'POST' || method === 'PUT') {
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    }

    // Test connection function
    function testConnection() {
      const serverId = [[${server.id}]];
      if (!serverId) {
        alert('Please save the server first before testing.');
        return;
      }

      const resultDiv = document.getElementById('testResult');
      resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Testing connection...';
      resultDiv.style.display = 'block';

      // Trigger a manual health check for this specific server
      $.get('/api/batch/check-now')
        .done(function(data) {
          if (data.status === 'success' && data.results) {
            const serverResult = data.results.find(r => r.serverName === '[[${server.name}]]');
            if (serverResult) {
              if (serverResult.success) {
                resultDiv.innerHTML =
                  '<div class="alert alert-success">' +
                  '<i class="fas fa-check-circle"></i> Connection successful! ' +
                  'Response time: ' + serverResult.elapsedTime + 'ms' +
                  '</div>';
              } else {
                resultDiv.innerHTML =
                  '<div class="alert alert-danger">' +
                  '<i class="fas fa-exclamation-circle"></i> Connection failed: ' +
                  serverResult.errorMessage +
                  '</div>';
              }
            } else {
              resultDiv.innerHTML =
                '<div class="alert alert-warning">' +
                '<i class="fas fa-question-circle"></i> Server not found in results' +
                '</div>';
            }
          } else {
            resultDiv.innerHTML =
              '<div class="alert alert-danger">' +
              '<i class="fas fa-exclamation-circle"></i> Test failed: ' + (data.message || 'Unknown error') +
              '</div>';
          }
        })
        .fail(function() {
          resultDiv.innerHTML =
            '<div class="alert alert-danger">' +
            '<i class="fas fa-exclamation-circle"></i> Test failed: Could not connect to health check service' +
            '</div>';
        });
    }

    // Initialize form on load
    $(document).ready(function() {
      toggleRequestBody();

      // Validate JSON in request body
      $('#requestBody').on('blur', function() {
        const value = $(this).val().trim();
        if (value && value !== '') {
          try {
            JSON.parse(value);
            $(this).removeClass('is-invalid');
          } catch (e) {
            $(this).addClass('is-invalid');
          }
        } else {
          $(this).removeClass('is-invalid');
        }
      });
    });
  </script>
</div>
</body>
</html>